C51 COMPILER V9.60.0.0   MAIN                                                              04/10/2023 10:03:49 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: D:\keil5\C51\BIN\C51.EXE User\main.c OMF2 WARNINGLEVEL(0) OPTIMIZE(9,SPEED) BROWSE INCDIR(.\Library
                    -\Core;.\User;.\Library\Core) VARBANKING DEBUG PRINT(.\Listings\main.lst) TABS(2) OBJECT(.\Objects\main.obj)

line level    source

   1          /******************* (C) COPYRIGHT 2019 Fortiortech Shenzhen *******************
   2           * File Name          : main.c
   3           * Creat Author       : Any Lin, R&D
   4           * Modify Author      : carl chen, R&D
   5           * Creat Date         : 2022-02-11
   6           * Modify Date        : 2022-02-11
   7           * Description        :
   8           ********************************************************************************
   9           * All Rights Reserved
  10           *******************************************************************************/
  11          
  12          /******************************************************************************/ // Including Header Files
  13          #include <main.h>
  14          #include <FU68xx_5_MCU.h>
  15          /******************************************************************************/ // Define Macro
  16          #define GOTO_MAIN (FLAG_BASE + 0x00)                                             // 31æ•°æ®æ ¡éªŒå®Œæˆæ 
             -‡å¿—  Flash_Sector_Write(GOTO_MAIN, 0xaa); //bootå®Œæˆæ ‡è®°
  17          #define MAIN_NO_ENPTY (FLAG_BASE + 0x01)                                         // ä¸»ç¨‹åºæ˜¯å¦ç©ºæ ‡å
             -¿—
  18          #define NAD_ADD (FLAG_BASE + 0x02)                                               // ä¸»ç¨‹åºæ˜¯å¦ç©ºæ ‡å
             -¿—
  19          #define CRCH_ADD (FLAG_BASE + 0x08)                                               // å­˜æ”¾appæ ¡éªŒçš„åœ°
             -å€
  20          #define CRCL_ADD (FLAG_BASE + 0x09)                                               // å­˜æ”¾appæ ¡éªŒçš„åœ°
             -å€
  21          /******************************************************************************/ // Define Global Symbols
  22          typedef struct
  23          {
  24              uint8 Flowlost_flag : 1;     /* ä¸¢åŒ…æ ‡å¿—0ï¼šæ•°æ®åŒ…æ­£å¸¸ 1ï¼šæ•°æ®åŒ…ä¸¢å¤± */
  25              uint8 Flow_Mode : 2;         /* å½“å‰çš„æ•°æ®æµçŠ¶æ€ 0ï¼šæ•°æ®æµæ²¡æœ‰å¼€å§‹ 1ï¼šæ•°æ®æµå¼€å§‹
             - 2ï¼šæ•°æ®æµæ¥æ”¶å®Œæˆ  */
  26              uint8 BSC_ERR_flag : 1;      /* 36æœåŠ¡çš„bscæ•°æ®å—é”™è¯¯ */
  27              uint8 : 4;                   /* ç©º */
  28              uint8 PCI;                   /* æ•°æ®é•¿åº¦ */
  29              uint8 SID;                   /* æœåŠ¡id */
  30              uint8 DID;                   /* æ•°æ®id */
  31              uint8 N_Data[Block_Len + 6]; /* udsæ•°æ® æ³¨æ„æœ€å¤§çš„æ•°æ®é•¿åº¦ä¸º64+2  */
  32              uint8 N_DataCount;           /* æœåŠ¡å­—èŠ‚çš„è®¡æ•° */
  33              uint8 N_DataFlow;            /* å¤šåŒ…æ•°æ®æµè®°å½• æ•°å€¼0x20-0x2f*/
  34          } UDS_TypeDef;                   /* UDSæœåŠ¡æ•°æ® */
  35          
  36          typedef struct
  37          {
  38              uint8 NAD;       /* NDAåœ°å€å­—æ®µ */
  39              uint8 PCI;       /* æœ‰æ•ˆæ•°æ®é•¿åº¦ */
  40              uint8 SID;       /* æœåŠ¡ID */
  41              uint8 DATA[6];   /* å›å¤udsæ•°æ® */
  42              uint8 NRSID;     /* å¦å®šåº”ç­”æ—¶å€™çš„NRSID */
  43              uint8 BSC;       /* å¦å®šåº”ç­”æ—¶å€™çš„BSC */
  44              uint8 ErrorCode; /* å¦å®šåº”ç­”æ—¶å€™çš„NCR*/
  45          } Respond_TypeDef;   /* å›å¤æ•°æ® */
  46          
  47          typedef struct
  48          {
C51 COMPILER V9.60.0.0   MAIN                                                              04/10/2023 10:03:49 PAGE 2   

  49              uint8 P_flag : 4;     /* ç¼–ç¨‹æ¨¡å¼0ï¼šå…¶ä»–ï¼Œ 1ï¼šè¿›å…¥ç¼–ç¨‹æ¨¡å¼ ï¼Œ2ï¼šè§£é”å®Œæˆ ï¼Œ3ï¼šå
             -ˆ é™¤å­˜å‚¨ç©ºé—´å®Œæˆ 4:è·å–ä¸‹è½½åœ°å€å’Œç©ºé—´ 5:æ•°æ®ä¼ è¾“ 6:ç»“æŸæ•°æ®ä¼ è¾“ 6:ç»“æŸæ•°æ®ä¼ è¾“ 7.CRC16æ•
             -°æ®æ£€æŸ¥*/
  50              uint8 KEY_flag : 1;   /* è§£é”æ“ä½œæ ‡å¿—ä½   1ï¼šè§£é”å®Œæˆ ï¼Œ0ï¼šæœªè§£é” */
  51              uint8 Reset_flag : 1; /* å¤ä½æ ‡å¿— å›å¤å®Œæ•°æ®åå¼€å§‹å¤ä½æ“ä½œ  1ï¼šç­‰å¾…å¤ä½ ï¼Œ0ï¼šå…
             -¶ä»– */
  52              uint8 Erase_flag : 2; /* æ“¦é™¤æ¨¡å¼ 0ï¼šç»“æŸæ“¦é™¤ 1ï¼šæ¥æ”¶åˆ°æ“¦é™¤ ï¼Œ2ï¼šå›å¤æ“¦é™¤ 3ï¼šæ“¦
             -é™¤ä¸­ */
  53              uint16 WriteAddress;  /* å­˜å‚¨åœ°å€  */
  54              uint32 MemoryAddress; /* å­˜å‚¨åœ°å€  */
  55              uint32 MemorySize;    /* å­˜å‚¨ç©ºé—´æ‰€å å­—èŠ‚æ•° */
  56          } Program_TypeDef;        /* ç¼–ç¨‹å‚æ•°è®¾ç½® */
  57          
  58          typedef struct
  59          {
  60              uint8 RUN_flag;   // LINæ ‡å¿—ä½
  61              uint8 Syn;        //åŒæ­¥æ•°æ®
  62              uint8 PID;        // LINID æ­¤å¤„çš„PID  ,ID=PID&0x3fæ˜¯ä½6ä½
  63              uint8 Data[8];    // LINæ•°æ®
  64              uint8 SData[8];   // LINå‘é€æ•°æ®
  65              uint8 Leng;       // LINæ•°æ®é•¿åº¦
  66              uint8 Check;      // LINæ•°æ®æ ¡éªŒ
  67              uint8 CheckMode;  // LINæ•°æ®æ ¡éªŒæ¨¡å¼ 1:å¢å¼ºæ ¡éªŒå’Œ  0:æ ‡å‡†æ ¡éªŒ
  68              uint8 Count;      // LINè®¡æ•°
  69              uint8 Err;        // LINé”™è¯¯
  70              uint8 Sleep_flag; //æ€»çº¿ä¼‘çœ 
  71              uint8 Send_flag;  //æ€»çº¿å‘é€æ ‡å¿—ä½
  72              uint16 Timeblank; //æ€»çº¿4ç§’æ— æ•°æ®ä¼‘çœ   åŒæ­¥é—´éš”æ®µæ—¶é—´
  73          } LIN_Struc;
  74          
  75          typedef enum
  76          {
  77              NO_ERR = 0,    //æ— é”™è¯¯
  78              ERR_BLANK = 1, //åŒæ­¥é—´éš”æ®µ
  79              ERR_SYNC = 2,  //åŒæ­¥å¸§é”™è¯¯
  80              ERR_PID = 3,   // PIDè¶…æ—¶é”™è¯¯
  81              ERR_DATA = 4,  //æ•°æ®è¶…æ—¶é”™è¯¯
  82              ERR_CHECK = 5, //æ•ˆéªŒå’Œé”™è¯¯
  83          } LINStaType;
  84          typedef enum
  85          {
  86              FLA_OK = 0,
  87              FLA_ERR,
  88              FLA_FZ,
  89          } ETypeFlaSta;
  90          
  91          uint8 MNAD = 0;
  92          UDS_TypeDef xdata UDS = {0};
  93          Respond_TypeDef xdata LINReply = {0};
  94          Program_TypeDef xdata USER = {0};
  95          LIN_Struc xdata Lin = {0};
  96          
  97          /*******LINé€šä¿¡ç¡¬ä»¶æ¥å£å‡½æ•°*********/
  98          void MODE_IO(void);
  99          void MODE_UART(void);
 100          void TIM3_Init(void);
 101          void PO0_INT(void);
 102          void LIN_INT(void);
 103          void TIEM3_INT(void);
 104          void LIN_detect(void);
 105          void Cutover_IO(void);
 106          /*******LINæ•°æ®é€šä¿¡å‡½æ•°*********/
C51 COMPILER V9.60.0.0   MAIN                                                              04/10/2023 10:03:49 PAGE 3   

 107          void LIN_Parse(uint8 *LIN_data);
 108          void LIN_Resp(void);
 109          void LIN_list(uint8 PID);
 110          void ReceiveSYS(uint8 PID);
 111          uint8 LinCheck(uint8 CheckMode, uint8 PID, uint8 Leng, uint8 *str);
 112          void LIN_Send(uint8 *str, uint8 Check, uint8 Leng);
 113          
 114          /******* Flashæ“ä½œå‡½æ•°*********/
 115          void Flash_Erase_APP(void);
 116          void Write64Byte64Flash(uint16 FlashAddress, uint8 *Buff, uint8 leng);
 117          void Flash_CRC_APP(uint32 Add,uint32 Size);
 118          
 119          /******* udsä¸‹è½½å‡½æ•°*********/
 120          void Service_Inquiry(void);
 121          uint8 UDS_Srv10_Resp(void);
 122          uint8 UDS_Srv27_Resp(void);
 123          uint8 UDS_Srv31_Resp(void);
 124          uint8 UDS_Srv34_Resp(void);
 125          uint8 UDS_Srv36_Resp(void);
 126          uint8 UDS_Srv37_Resp(void);
 127          uint8 UDS_Srv11_Resp(void);
 128          uint8 UDS_Srv19_Resp(void);
 129          
 130          /* é…ç½®ä¸²å£2çš„rxç®¡è„šä¸ºå¤–éƒ¨ä¸­æ–­ */
 131          void MODE_IO(void)
 132          {
 133   1          Lin.Sleep_flag = 0;         /* æ€»çº¿ä¼‘çœ æ ‡å¿—ä½ */
 134   1          UT2REN = 0;                 /* 0-->ä¸å…è®¸ä¸²è¡Œè¾“å…¥ 1-->å…è®¸ä¸²è¡Œè¾“å…¥ï¼Œè½¯ä»¶æ¸…0; */
 135   1                                      /*   UT2RI = 0;  æ¸…é™¤æ¥æ”¶ä¸­æ–­ */
 136   1          ClrBit(UT2_BAUD, UART2IEN); /* å…³é—­ UART2 ä¸­æ–­è¿›å…¥ioæ¨¡å¼ */
 137   1          ClrBit(P0_OE, PIN1);        /* è¾“å…¥æ¨¡å¼*/
 138   1          ClrBit(P0_PU, PIN1);        /*ä¸Šæ‹‰ç¦æ­¢*/
 139   1          /* è®¾ç½®EXT0==0001ï¼šé…ç½® P0.1 ä¸ºå¤–éƒ¨ä¸­æ–­ 0 æ¥å£ */
 140   1          ClrBit(LVSR, EXT0CFG2); /* P01 æ¥å£å¤–éƒ¨ä¸­æ–­ 0 é…ç½® */
 141   1          ClrBit(LVSR, EXT0CFG1);
 142   1          SetBit(LVSR, EXT0CFG0);
 143   1          /* é…ç½®ä¸ºä¸‹é™æ²¿è§¦å‘ä¸­æ–­ */
 144   1          IT01 = 1; /* ç”µå¹³å˜åŒ–è§¦å‘ä¸­æ–­ */
 145   1          IT00 = 0;
 146   1          /* æ¸…é™¤å¤–éƒ¨ä¸­æ–­ */
 147   1          IF0 = 0;
 148   1          /* é…ç½®ä¸­æ–­ä¼˜å…ˆçº§ */
 149   1          EX0 = 1; /* ä½¿èƒ½å¤–éƒ¨ä¸­æ–­0 */
 150   1      }
 151          
 152          /*-------------------------------------------------------------------------------------------------
 153              Function Name : void UART_Init(void)
 154              Description   : UART å‚æ•°é…ç½® å¹¶ åˆå§‹åŒ–
 155              Input         : æ— 
 156              Output      : æ— 
 157          -------------------------------------------------------------------------------------------------*/
 158          void MODE_UART(void)
 159          {
 160   1      
 161   1          EX0 = 0;                   /* å…³é—­å¤–éƒ¨ä¸­æ–­0  è¿›å…¥ä¸²å£æ¨¡å¼ */
 162   1          SetBit(PH_SEL, UART2EN);   /* P3[6]as UART2_RXD; P3[7]as UART2_TXD */
 163   1          SetBit(PH_SEL1, UART2CH1); /* 1Xï¼š P0.1 ä¸º RXDã€ P0.0 ä¸º TXDï¼ˆP0.1 ä¸ºå•çº¿æ¨¡å¼çš„è¾“å…¥è¾“å‡º
             -ï¼‰*/
 164   1          UT2MOD1 = 0;               /* 00-->å•çº¿åˆ¶8bit        01-->8bit uart(æ³¢ç‰¹ç‡å¯è®¾ç½®) */
 165   1          UT2MOD0 = 1;               /* 10-->å•çº¿åˆ¶9bit        11-->9bit uart(æ³¢ç‰¹ç‡å¯è®¾ç½®) */
 166   1          UT2SM2 = 0;                /* 0-->å•æœºé€šè®¯          1-->å¤šæœºé€šè®¯ï¼›*/
 167   1          UT2REN = 1;                /* 0-->ä¸å…è®¸ä¸²è¡Œè¾“å…¥ 1-->å…è®¸ä¸²è¡Œè¾“å…¥ï¼Œè½¯ä»¶æ¸…0; */
C51 COMPILER V9.60.0.0   MAIN                                                              04/10/2023 10:03:49 PAGE 4   

 168   1          UT2TB8 = 0;                /* æ¨¡å¼2/3ä¸‹æ•°æ®å‘é€ç¬¬9ä½ï¼Œåœ¨å¤šæœºé€šä¿¡ä¸­ï¼Œå¯ç”¨äºåˆ¤æ–­å½
             -“å‰æ•°æ®å¸§çš„æ•°æ®æ˜¯åœ°å€è¿˜æ˜¯æ•°æ®ï¼ŒTB8=0ä¸ºæ•°æ®ï¼ŒTB8=1ä¸ºåœ°å€ */
 169   1          UT2RB8 = 0;                /* æ¨¡å¼2/3ä¸‹æ•°æ®æ¥æ”¶ç¬¬9ä½ï¼Œè‹¥SM2=0,ä½œä¸ºåœæ­¢ä½ */
 170   1          ClrBit(IP3, PSPI_UT21);    /* ä¸­æ–­ä¼˜å…ˆçº§ */
 171   1          SetBit(IP3, PSPI_UT20);    /* ä¸­æ–­ä¼˜å…ˆçº§ */
 172   1      
 173   1          UT2_BAUD = 0x4D; /*æ³¢ç‰¹ç‡å¯è®¾ç½® = 24000000/(16/(1+ UT_BAUD[BAUD_SEL]))/(UT_BAUD+1)*/
 174   1          /* 9B-->9600 0x000c-->115200 0x0005-->256000  4D-->19200*/
 175   1          ClrBit(UT2_BAUD, BAUD2_SEL); /*å€é¢‘ä½¿èƒ½0-->Disable  1-->Enable*/
 176   1          SetBit(UT2_BAUD, UART2IEN);  /* UART2 ä¸­æ–­ä½¿èƒ½0-->Disable  1-->Enable*/
 177   1      }
 178          
 179          /*---------------------------------------------------------------------------*/
 180          /*  Name     :   void TIM3_Init(void)
 181              /* Input    :   NO
 182              /* Output   :   NO
 183              /* Description: Timer3çš„åˆå§‹åŒ–ï¼Œåªç”¨äºè®¡æ•°å™¨ä½¿ç”¨  ã€‚5.28msè§¦å‘å®šæ—¶å™¨
 184          /*---------------------------------------------------------------------------*/
 185          void TIM3_Init(void)
 186          {
 187   1          ClrBit(PH_SEL, T3SEL); /* Timer3ç«¯å£ä¸ä½¿èƒ½ */
 188   1      
 189   1          /*-------------------------------------------------------------------------------------------------
 190   1          Tim3_CR0
 191   1          [7:5]  T4PSC2 T4PSC1 T4PSC0  å®šæ—¶å™¨åˆ†é¢‘é…ç½®0
 192   1                          //000-->24M     001-->12M       010-->6M    011-->3M
 193   1                          //100-->1.5M    101-->750K      110-->375K  111-->187.5K
 194   1          [4]    T4OCM                 è¾“å…¥ timer æ¨¡å¼ï¼šå‘¨æœŸæ²¿é€‰æ‹©
 195   1          [3]    T4IRE                 è¾“å…¥ timer æ¨¡å¼ï¼šè„‰å®½æ£€æµ‹ä¸­æ–­ä½¿èƒ½
 196   1          [2]    RSV
 197   1          [1]    T4OPM                 è¾“å…¥ timer æ¨¡å¼ï¼šPWM å‘¨æœŸæ£€æµ‹æˆ–è®¡æ•°å™¨ä¸Šæº¢äº‹ä»¶
 198   1          [0]    T4MOD                 0ï¼šè¾“å…¥ timer æ¨¡å¼   1ï¼šè¾“å‡ºæ¨¡å¼
 199   1          -------------------------------------------------------------------------------------------------*/
 200   1          ClrBit(TIM3_CR0, T3PSC2); /* è®¡æ•°å™¨æ—¶é’Ÿåˆ†é¢‘é€‰æ‹© 011-->3M   0ã€‚333us */
 201   1          SetBit(TIM3_CR0, T3PSC1); /* 000-->24M    001-->12M   010-->6M  011-->3M */
 202   1          SetBit(TIM3_CR0, T3PSC0); /* 100-->1.5M 101-->750K    110-->375K  111-->187.5K */
 203   1      
 204   1          SetBit(TIM3_CR0, T3OCM); /* è¾“å…¥timeræ¨¡å¼ï¼Œå‘¨æœŸæ²¿é€‰æ‹©   0-->é«˜ç”µå¹³è„‰å®½   1-->ä½ç”µå¹³è
             -„‰å®½ */
 205   1          ClrBit(TIM3_CR0, T3IRE); /* æ¯”è¾ƒåŒ¹é…ä¸­æ–­/è„‰å®½æ£€æµ‹ä¸­æ–­   0-->Disable     1-->Enable */
 206   1          ClrBit(TIM3_CR0, T3OPM); /* è¾“å…¥æ¨¡å¼ï¼šPWMå‘¨æœŸæ£€æµ‹æˆ–è®¡æ•°å™¨ä¸Šæº¢äº‹ä»¶  0-->è®¡æ•°å™¨ä¸å
             -œæ­¢    1-->å•æ¬¡æ¨¡å¼(æ¸…é™¤ TxCEN) */
 207   1          ClrBit(TIM3_CR0, T3MOD); /* 0-->Timeræ¨¡å¼       1-->è¾“å‡ºæ¨¡å¼ */
 208   1      
 209   1          ClrBit(TIM3_CR1, T3IR); /* æ¸…é™¤æ ‡å¿—ä½ æ¯”è¾ƒä¸­æ–­ */
 210   1          ClrBit(TIM3_CR1, T3IP); /* æ¸…é™¤æ ‡å¿—ä½ */
 211   1          ClrBit(TIM3_CR1, T3IF); /* æ¸…é™¤æ ‡å¿—ä½ æº¢å‡ºä¸­æ–­ */
 212   1      
 213   1          ClrBit(TIM3_CR1, T3IPE); /* è¾“å…¥Timer PWMå‘¨æœŸæ£€æµ‹ä¸­æ–­ä½¿èƒ½ 0-->Disable  1-->Enable */
 214   1          SetBit(TIM3_CR1, T3IFE); /* è®¡æ•°å™¨ä¸Šæº¢ä¸­æ–­ä½¿èƒ½ 0-->Disable  1-->Enable */
 215   1          ClrBit(TIM3_CR1, T3NM1); /* è¾“å…¥å™ªå£°è„‰å®½é€‰æ‹© */
 216   1          ClrBit(TIM3_CR1, T3NM0); /* 00-->ä¸æ»¤æ³¢  01-->4cycles    10-->8cycles  11-->16cycles */
 217   1          SetBit(TIM3_CR1, T3EN);  /* TIM3ä½¿èƒ½    0-->Disable  1-->Enable */
 218   1      
 219   1          /* æ³¨æ„æº¢å‡ºä¸­æ–­çš„æ—¶é—´è¦å°äºè°ƒåº¦è¡¨çš„æ—¶é—´  å½“å‰è®¾å®šæ—¶é—´10ms */
 220   1          TIM3__ARR = 24001; /*  IRæ¯”è¾ƒä¸­æ–­ é‡è£…è½½å¯„å­˜å™¨ */
 221   1          TIM3__DR = 24002;  /* è®¾å®š10msä¸­æ–­  IFæº¢å‡ºä¸­æ–­ æ²¡æœ‰ä½¿èƒ½ */
 222   1          TIM3__CNTR = 1;
 223   1      
 224   1      }
 225          
 226          /*  ----------------------------------------------------------------------------------------------*/
C51 COMPILER V9.60.0.0   MAIN                                                              04/10/2023 10:03:49 PAGE 5   

 227          /*  Function Name  : put_char
 228              /*  Description    : put_char
 229              /*  Date           : 2020-09-06
 230              /*  Parameter      : c: [è¾“å…¥/å‡º]
 231              /*  ----------------------------------------------------------------------------------------------*/
 232          void put_char(uint8 c)
 233          {
 234   1          UT2_DR = c;
 235   1          while (UT2TI == 0)
 236   1              ;
 237   1          UT2TI = 0;
 238   1      }
 239          
 240          void LIN_Send(uint8 *str, uint8 Check, uint8 Leng)
 241          {
 242   1          uint8 i = 0;
 243   1      
 244   1          for (i = 0; i < Leng; i++)
 245   1          {
 246   2              put_char(str[i]);
 247   2          }
 248   1          put_char(Check);
 249   1      }
 250          /*  ----------------------------------------------------------------------------------------------*/
 251          /*  Function Name  : LinCheck è®¡ç®—æ•°æ®çš„æ ¡éªŒå’Œ
 252              /*  Description    : è¾“å…¥CheckMode:æ ¡éªŒæ¨¡å¼ ;
 253                                       PID:PDI;
 254                                       Leng:æ•°æ®é•¿åº¦;
 255                                       strï¼šè®¡ç®—æ•°ç»„;
 256              /*  Date           : 2020-09-06
 257              /*  Parameter      : è¿”å›æ ¡éªŒå’Œ
 258              /*  ----------------------------------------------------------------------------------------------*/
 259          uint8 LinCheck(uint8 CheckMode, uint8 PID, uint8 Leng, uint8 *str)
 260          {
 261   1          uint16 CheckDATA = 0; /* é»˜è®¤æ ‡å‡†æ ¡éªŒ */
 262   1          uint8 i = 0;
 263   1          //  CheckDATA = PID;/* å¢å¼ºå‹æ ¡éªŒ */
 264   1          for (i = 0; i < Leng; i++)
 265   1          {
 266   2              CheckDATA = CheckDATA + str[i];
 267   2              if (CheckDATA > 0xff) /* æ ¡éªŒæ–¹æ³• */
 268   2              {
 269   3                  CheckDATA = CheckDATA - 0xff;
 270   3              }
 271   2          }
 272   1          CheckDATA = 0xff - CheckDATA;
 273   1          return (uint8)CheckDATA;
 274   1      }
 275          
 276          void Cutover_IO(void)
 277          {
 278   1          Lin.RUN_flag = 0;
 279   1          MODE_IO();
 280   1      } /* ç«¯å£åˆ‡æ¢åˆ°å¤–éƒ¨ä¸­æ–­æ¨¡å¼ */
 281          
 282          /*---------------------------------------------------------------------------*/
 283          /*  Name     :   void TIEM3_INT(void)
 284              /* Input    :   NO
 285              /* Output   :   NO
 286              /* Description: linæ€»çº¿ä¸“ç”¨çš„è®¡æ—¶å™¨
 287          /*---------------------------------------------------------------------------*/
 288          void TIEM3_INT(void)
C51 COMPILER V9.60.0.0   MAIN                                                              04/10/2023 10:03:49 PAGE 6   

 289          {
 290   1          if (Lin.RUN_flag == 1)
 291   1          {
 292   2              Lin.RUN_flag = 0; /* åŒæ­¥é—´éš”æ®µè¶…æ—¶é”™è¯¯ */
 293   2              Lin.Err = ERR_BLANK;
 294   2          }
 295   1          else if (Lin.RUN_flag == 11)
 296   1          {
 297   2              Lin.RUN_flag = 0; /* åŒæ­¥ä¿¡å·è¶…æ—¶é”™è¯¯ */
 298   2          }
 299   1          else if (Lin.RUN_flag == 12)
 300   1          {
 301   2              Lin.RUN_flag = 0; /* æ¥æ”¶IDä¿¡å·è¶…æ—¶é”™è¯¯ */
 302   2              Lin.Err = ERR_PID;
 303   2          }
 304   1          else if (Lin.RUN_flag == 13)
 305   1          {
 306   2              Lin.RUN_flag = 0; /* æ¥æ”¶æ•°æ®è¶…æ—¶é”™è¯¯ */
 307   2              Lin.Err = ERR_DATA;
 308   2          }
 309   1          else if (Lin.RUN_flag == 23)
 310   1          {
 311   2              Lin.RUN_flag = 0; /* å‘é€æ•°æ®è¶…æ—¶é”™è¯¯ */
 312   2          }
 313   1          Cutover_IO(); /* åˆ‡æ¢å›ioæ¨¡å¼ */
 314   1                        /* put_char(0X55);//æµ‹è¯•ä¸²å£ */
 315   1          ClrBit(TIM3_CR1, T3IF);
 316   1      }
 317          
 318          /*  -------------------------------------------------------------------------------------------------
 319              Function Name  : FO_INT
 320              Description    : GP01å¤–éƒ¨ä¸­æ–­è§¦å‘äº‹ä»¶ç”µå¹³å˜åŒ–è§¦å‘ä¸­æ–­
 321              Date           : 2020-04-10
 322              Parameter      : None
 323              ------------------------------------------------------------------------------------------------- */
 324          void PO0_INT(void)
 325          {
 326   1          if (GP01 == 0) /*æ¥æ”¶åˆ°ä¸‹é™æ²¿*/
 327   1          {
 328   2              if (Lin.RUN_flag == 0)
 329   2              {
 330   3                  Lin.RUN_flag = 1;
 331   3                  ClrBit(TIM3_CR1, T3EN); /* å…ˆåœæ­¢è®¡æ•° */
 332   3                  TIM3__CNTR = 1;         /* æ¸…é™¤time3çš„è®¡æ•°å™¨ */
 333   3                  Lin.Timeblank = 0;
 334   3                  SetBit(TIM3_CR1, T3EN); /* ä½¿èƒ½è®¡æ•° */
 335   3              }
 336   2          }
 337   1          else
 338   1          {
 339   2              if (Lin.RUN_flag == 1)
 340   2              {
 341   3                  /* ä½ç”µå¹³æŒç»­æ—¶é—´æ»¡è¶³13ä½çš„åŒæ­¥é—´éš”æ–­è¦æ±‚ */
 342   3                  ClrBit(TIM3_CR1, T3EN); /* å…ˆåœæ­¢è®¡æ•° */
 343   3                  Lin.Timeblank = TIM3__CNTR;
 344   3                  /* 19200å¯¹åº”çš„åŒæ­¥æ—¶é—´ 13ä½  0.677MS  2031è®¡æ•°å€¼  åŒæ­¥é˜¶æ®µè¯¯å·®5%å¯ä»¥æ¥æ”¶ 
             -*/
 345   3                  // if ((Lin.Timeblank < 5060) && (Lin.Timeblank > 3860)) /*9600*/
 346   3                  if ((Lin.Timeblank < 3000) && (Lin.Timeblank > 1830)) /*19200*/
 347   3                  {
 348   4                      Lin.RUN_flag = 11;
 349   4                      MODE_UART(); /*åˆ‡æ¢åˆ°ä¸²å£æ¨¡å¼*/
C51 COMPILER V9.60.0.0   MAIN                                                              04/10/2023 10:03:49 PAGE 7   

 350   4                  }
 351   3                  else
 352   3                  {
 353   4                      Lin.RUN_flag = 0;
 354   4                  }
 355   3                  /* æ•°ä¸€ç»„æ•°æ®æœ€å¤§ä¸ä¼šåœç•™7ms æ ¹æ®å‘é€è°ƒåº¦è¡¨è®¡ç®— */
 356   3                  TIM3__CNTR = 1;         /* æ¸…é™¤time3çš„è®¡æ•°å™¨ */
 357   3                  SetBit(TIM3_CR1, T3EN); /* ä½¿èƒ½è®¡æ•° */
 358   3              }
 359   2          }
 360   1      
 361   1          IF0 = 0; /* clear P01 interrupt flag*/
 362   1      }
 363          /* -------------------------------------------------------------------------------------------------
 364              Function Name  : LIN_IRQ
 365              Description    : LINä¸­æ–­å‡½æ•°
 366              Date           : 2020-07-20
 367              Parameter      : None
 368          ------------------------------------------------------------------------------------------------- */
 369          void LIN_INT(void)
 370          {
 371   1          switch (Lin.RUN_flag)
 372   1          {
 373   2      
 374   2          /**************æ¥æ”¶åŒæ­¥ä¿¡å·***********/
 375   2          case 11:
 376   2          {
 377   3              Lin.Syn = UT2_DR;
 378   3              if (Lin.Syn == 0X55) /* åŒæ­¥ä¿¡å· */
 379   3              {
 380   4                  Lin.RUN_flag = 12;
 381   4              }
 382   3              else
 383   3              {
 384   4                  Lin.Err = ERR_SYNC;
 385   4              }
 386   3          }
 387   2          break;
 388   2      
 389   2          /**************æ³¨æ„æ­¤å¤„æ¥æ”¶çš„ä¸æ˜¯IDè€Œæ˜¯PIDï¼ŒPIDæ˜¯idåŠ å‰ä¸¤ä½æ ¡éªŒç»„åˆå¾—åˆ°çš„æ³¨æ„
             -,æ³¨æ„,æ³¨æ„,æ³¨æ„,æ³¨æ„***********/
 390   2          case 12:
 391   2          {
 392   3              Lin.PID = UT2_DR;
 393   3              /*--------æ•°æ®åˆ—è¡¨-----------*/
 394   3              LIN_list(Lin.PID);
 395   3              /*--------æ•°æ®åˆ—è¡¨-----------*/
 396   3          }
 397   2          break;
 398   2      
 399   2          /************æ¥æ”¶æ•°æ®é˜¶æ®µæ•°æ®é•¿åº¦ä¸€å®šè¦åŒ¹é…ä¸Š***********/
 400   2          case 13:
 401   2          {
 402   3              if (Lin.Count == Lin.Leng) /* æ¥æ”¶æœ€åä¸€ä¸ªæ ¡éªŒä½ æ³¨æ„æ¥æ”¶çš„æ•°æ®é•¿åº¦Lengä¸€å®šè¦
             -æ­£ç¡® */
 403   3              {
 404   4                  Lin.Check = UT2_DR;
 405   4                  if (Lin.Check == LinCheck(Lin.CheckMode, Lin.PID, Lin.Leng, &Lin.Data))
 406   4                  {
 407   5                      /*--------æ•°æ®åˆ—è¡¨å¤„ç†-----------*/
 408   5                      ReceiveSYS(Lin.PID);
 409   5                      /*--------æ•°æ®åˆ—è¡¨å¤„ç†-----------*/
C51 COMPILER V9.60.0.0   MAIN                                                              04/10/2023 10:03:49 PAGE 8   

 410   5                  }
 411   4                  else /* æ•°æ®æ ¡éªŒé”™è¯¯ */
 412   4                  {
 413   5                      Lin.Err = 1; /* æš‚æ—¶ä¸åšé”™æ£€æµ‹ */
 414   5                  }
 415   4                  Cutover_IO();
 416   4              }
 417   3              else /* æ¥æ”¶å®šé•¿æ•°æ® */
 418   3              {
 419   4                  Lin.Data[Lin.Count] = UT2_DR;
 420   4                  Lin.Count++;
 421   4              }
 422   3          }
 423   2          break;
 424   2      
 425   2              /************æ•°æ®å‘é€***********/
 426   2          case 23:
 427   2              break;
 428   2      
 429   2          /************æ¥æ”¶åˆ°å…¶ä»–æ•°æ®è¿”å›IOæ£€æµ‹***********/
 430   2          default:
 431   2          {
 432   3              Cutover_IO();
 433   3              break;
 434   3          }
 435   2          }
 436   1          UT2RI = 0; /*æ¸…é™¤æ¥æ”¶ä¸­æ–­*/
 437   1      }
 438          /* linä¿¡å·æ•°æ®æ£€æµ‹ */
 439          void LIN_detect(void)
 440          {
 441   1          if (IF0) /* å¤–éƒ¨ä¸­æ–­æ ‡å¿— ç½®ä¸€ */
 442   1          {
 443   2              PO0_INT();
 444   2          }
 445   1          if (UT2RI) /*æ¥æ”¶å®Œæˆä¸­æ–­*/
 446   1          {
 447   2              LIN_INT();
 448   2          }
 449   1          if (ReadBit(TIM3_CR1, T3IF)) /*å®šæ—¶å™¨3æº¢å‡ºä¸­æ–­äº‹ä»¶*/
 450   1          {
 451   2              TIEM3_INT();
 452   2          }
 453   1          if (ReadBit(TIM3_CR1, T3IP)) /*æ¯”è¾ƒä¸­æ–­äº‹ä»¶*/
 454   1          {
 455   2              ClrBit(TIM3_CR1, T3IP);
 456   2          }
 457   1          if (ReadBit(TIM3_CR1, T3IR)) /*æ¯”è¾ƒä¸­æ–­äº‹ä»¶*/
 458   1          {
 459   2              ClrBit(TIM3_CR1, T3IR);
 460   2          }
 461   1      }
 462          
 463          /*  -------------------------------------------------------------------------------------------------
 464              Function Name  : ReceiveSYS
 465              Description    : æ€»çº¿æ¥æ”¶æ•°æ®å¤„ç†
 466              Date           :
 467                             : [è¾“å…¥]
 468              ------------------------------------------------------------------------------------------------- */
 469          void ReceiveSYS(uint8 PID)
 470          {
 471   1          uint8 LIN_WD = 0;
C51 COMPILER V9.60.0.0   MAIN                                                              04/10/2023 10:03:49 PAGE 9   

 472   1          uint8 temp = 0;
 473   1          switch (PID)
 474   1          {
 475   2          case 0x3c: /*æ¥æ”¶æ•°æ®ID=0x3c*/
 476   2          {
 477   3              if (Lin.Data[0] == MNAD) /* æ•°æ®ndaç¬¦åˆè¦æ±‚ */
 478   3              {
 479   4                  LIN_Parse(&Lin.Data); /* è¿›å…¥è¯Šæ–­å‡½æ•°è¯Šæ–­ */
 480   4              }
 481   3          }
 482   2          break;
 483   2      
 484   2          default:
 485   2              break;
 486   2          }
 487   1      }
 488          
 489          /******************************************************************************/ // Function Subject
 490          ETypeFlaSta Flash_Erase(uint8 xdata *FlashAddress)
 491          {
 492   1          SetBit(WDT_CR, WDTRF);/* å…ˆå–‚ç‹— */
 493   1          FLA_CR = 0x05; /* é¢„ç¼–ç¨‹ä½¿èƒ½ */
 494   1          FLA_CR = 0x03; /* ä½¿èƒ½è‡ªæ“¦é™¤ */
 495   1          FLA_KEY = 0x5a;
 496   1          FLA_KEY = 0x1f; /* flashé¢„ç¼–ç¨‹è§£é” */
 497   1          *FlashAddress = 0xff; /* å†™ä»»æ„æ•°æ® */
 498   1          FLA_CR = 0x08;        /* å®ŒæˆåFlashå†æ¬¡ä¸Šé” */
 499   1          if ((FLA_CR & FLAERR) == FLAERR)
 500   1              return FLA_ERR;
 501   1          return FLA_OK;
 502   1      }
 503          /*
 504          **********************************************************************************************************
             -***************************************************************************
 505          @   Brief    ï¼šFlash_Erase_APP
 506          @   Param    ï¼šæ¸…é™¤appæ®µçš„ç¨‹åº
 507          @    Date    ï¼š2022 - 01 - 11
 508          **********************************************************************************************************
             -****************************************************************************
 509          */
 510          void Flash_Erase_APP(void)
 511          {
 512   1          uint8 i = 0;
 513   1          uint8 xdata *FlashStartAddr = PADDR;/* ä¿å­˜nadé…ç½® */
 514   1         /* é˜²æ­¢æŒ‡é’ˆè·‘é£è¿›å…¥è¿™é‡Œå»æ“¦é™¤ä¸»ç¨‹åº */
 515   1        if (*(unsigned char code *)GOTO_MAIN && *(unsigned char code *)MAIN_NO_ENPTY)
 516   1          {
 517   2              (*(void (*)())PADDR)(); /* è·³è½¬å‡½æ•°  */ 
 518   2          }
 519   1        if(USER.P_flag == 3)
 520   1        {
 521   2            for (i = 0; (FlashStartAddr + (i * FLA_SECTOR_WIDT) < FLASH_END_ADDR); i++)
 522   2          {
 523   3            if (Flash_Erase(FlashStartAddr + (i * FLA_SECTOR_WIDT)) != FLA_OK) /* æ²¡æœ‰æ“¦é™¤æ­£ç¡®ï¼Œåœ¨æ“¦é™¤ä¸€
             -æ¬¡ */
 524   3            {
 525   4              Flash_Erase(FlashStartAddr + (i * FLA_SECTOR_WIDT));
 526   4            }
 527   3          }
 528   2        }
 529   1      
 530   1      }
C51 COMPILER V9.60.0.0   MAIN                                                              04/10/2023 10:03:49 PAGE 10  

 531          /* -------------------------------------------------------------------------------------------------
 532              Function Name  : Flash_Sector_Write
 533              Description    : Flashè‡ªçƒ§å†™: å¯¹æ‰‡åŒºé¢„ç¼–ç¨‹å’Œè‡ªæ“¦é™¤åï¼Œå¯ä»¥å¯¹æ‰‡åŒºå†…çš„åœ°å€è¿›è¡Œ
             -Flashçƒ§å†™ï¼Œ
 534                              ä¸€æ¬¡çƒ§å†™ä¸€ä¸ªbyte,ä¸€å®šè¦åœ¨è§£é”åæ‰ç»™DPTRèµ‹å€¼
 535              Date           : 2020-07-23
 536              Parameter      : FlashAddress: [è¾“å…¥/å‡º]
 537          ------------------------------------------------------------------------------------------------- */
 538          void Flash_Sector_Write(uint16 FlashAddress, uint8 FlashData)
 539          {
 540   1          /* EA = 0; Flashè‡ªçƒ§å†™å‰å…ˆå…³æ€»ä¸­æ–­ */
 541   1          FLA_CR = 0x01;                            /* ä½¿èƒ½Flashç¼–ç¨‹ */
 542   1          FLA_KEY = 0x5a;                           /* è§£é” */
 543   1          FLA_KEY = 0x1f;                           /* flashé¢„ç¼–ç¨‹è§£é” */
 544   1          *(uint8 xdata *)FlashAddress = FlashData; /* å†™ç¼–ç¨‹æ•°æ® */
 545   1          FLA_CR = 0x08;                            /* å¼€å§‹é¢„ç¼–ç¨‹ï¼Œå®ŒæˆåFlashå†æ¬¡ä¸Šé” */
 546   1      }
 547          /* -------------------------------------------------------------------------------------------------
 548              Function Name  : void WriteData2Flash(uint8 xdata *BlockStartAddr,uint16 NewData2Flash)
 549              Description    : å†™å…¥lengä¸ªå­—èŠ‚åˆ°FLASHã€‚å…¶ä¸­Inputï¼šFlashAddressï¼šç›®æ ‡èµ·å§‹ FLASHåœ°å€  
             -NewData2Flashï¼šè¢«å†™å…¥æ•°æ® é•¿åº¦:leng
 550              Outputï¼š1:æ‰‡åŒºæœªæ»¡,å†™å…¥å®Œæˆ  0:æ‰‡åŒºå·²æ»¡,å†™å…¥å¤±è´¥
 551              Date           : 2020-07-23
 552              Parameter      : æ–­ç”µä¹‹å‰å†™å…¥å½“å‰çš„ä½ç½®ä¿¡æ¯
 553          ------------------------------------------------------------------------------------------------- */
 554          void Write64Byte64Flash(uint16 FlashAddress, uint8 *Buff, uint8 leng)
 555          {
 556   1          uint16 i;
 557   1          uint8 FlashData = 0;
 558   1          for (i = 0; i < leng; i++)
 559   1          {
 560   2              FlashData = *Buff++;
 561   2              Flash_Sector_Write((FlashAddress + i), FlashData);
 562   2          }
 563   1      }
 564          
 565          /* -------------------------------------------------------------------------------------------------
 566              Function Name  : void Flash_CRC_APP(uint8 xdata *BlockStartAddr,uint16 NewData2Flash)
 567              Description    : CRCæ ¡éªŒ çš„èµ·å§‹åœ°å€å’Œç»“æŸåœ°å€æ˜¯ç”±0x36æœåŠ¡æ‰€ç»™çš„å‚æ•°å†³å®šçš„
 568              Date           : 2022-02-23
 569              Parameter      : æ–­ç”µä¹‹å‰å†™å…¥å½“å‰çš„ä½ç½®ä¿¡æ¯
 570          ------------------------------------------------------------------------------------------------- */
 571          uint8 CRCL = 0;
 572          uint8 CRCH = 0;
 573          void Flash_CRC_APP(uint32 Add,uint32 Size)
 574          {
 575   1          ClrBit(CRC_CR, AUTOINT); /* åœæ­¢è®¡ç®— */
 576   1          SetBit(CRC_CR, CRCVAL);  /* å°† CRC ç»“æœåˆå§‹åŒ–ä¸º 0xFFFF */
 577   1          SetBit(CRC_CR, CRCDINI); /* åˆå§‹åŒ–æœ‰æ•ˆ */
 578   1      
 579   1          CRC_BEG = Add >> 8;
 580   1          CRC_CNT = (Size >> 8) - 1;
 581   1          SetBit(CRC_CR, AUTOINT); /* å¼€å§‹è®¡ç®— */
 582   1          while (ReadBit(CRC_CR, CRCDONE) == 0)
 583   1          {
 584   2              ;
 585   2          }
 586   1          ClrBit(CRC_CR, CRCPNT); /* å–crcä½ä½ */
 587   1          CRCL = CRC_DR;
 588   1          SetBit(CRC_CR, CRCPNT); /* å–crcé«˜ä½ */
 589   1          CRCH = CRC_DR;
 590   1      }
C51 COMPILER V9.60.0.0   MAIN                                                              04/10/2023 10:03:49 PAGE 11  

 591          
 592          /* -------------------------------------------------------------------------------------------------
 593              Function Name  :  LIN_Parse(uint8 *LIN_data)
 594              Description    :  linæ¥æ”¶æ•°æ®è§£æ
 595              Date           : 2022-02-28
 596          ------------------------------------------------------------------------------------------------- */
 597          void LIN_Parse(uint8 *LIN_data)
 598          {
 599   1          uint8 i, Startdata;
 600   1          uint8 Startbyte = SBYTE; /* èµ·å§‹å­—èŠ‚ */
 601   1      
 602   1          Startdata = LIN_data[0 + Startbyte];
 603   1      
 604   1          switch (Startdata & 0xf0)
 605   1          {
 606   2      
 607   2              /***********0x00å•åŒ…æ•°æ®***********/
 608   2          case 0x00:
 609   2              UDS.PCI = Startdata;                     /* æ•°æ®é•¿åº¦ åŒ…å«æ•°æ®æœåŠ¡*/
 610   2              UDS.SID = LIN_data[1 + Startbyte];       /* æœåŠ¡id */
 611   2              UDS.DID = LIN_data[2 + Startbyte];       /* æ•°æ®id */
 612   2              UDS.N_Data[0] = LIN_data[3 + Startbyte]; /* æ•°æ®id */
 613   2              UDS.N_Data[1] = LIN_data[4 + Startbyte]; /* æ•°æ®id */
 614   2              UDS.N_Data[2] = LIN_data[5 + Startbyte]; /* æ•°æ®id */
 615   2              UDS.N_Data[3] = LIN_data[6 + Startbyte]; /* æ•°æ®id */
 616   2                                                       //        for (i = 0; i < (UDS.PCI - (2 + Startbyte)); i+
             -+) /* æ•°æ®å†…å®¹å­˜æ”¾-æ•°æ®æœåŠ¡*/
 617   2                                                       //        {
 618   2                                                       //            UDS.N_Data[i] = LIN_data[2 + i + Startbyte]
             -;
 619   2                                                       //        }
 620   2              Service_Inquiry();                       /* è¿›å…¥udsæœåŠ¡æŸ¥è¯¢å‡½æ•° */
 621   2              UDS.Flow_Mode = 0;                       /* å¤šåŒ…æ•°æ®æµæœªå¼€å§‹ */
 622   2              UDS.Flowlost_flag = 0;                   /* æ¸…é™¤ä¸¢åŒ…æ ‡å¿—ä½ */
 623   2              break;
 624   2      
 625   2              /***********0x10å¤šåŒ…é¦–å¸§  å®é™…è¿™é‡Œåªæœ‰2ä¸ªå¤šåŒ…çš„æœåŠ¡åˆ†åˆ«ä¸º 34å’Œ36***********/
 626   2          case 0x10:
 627   2              UDS.PCI = LIN_data[1 + Startbyte]; /* æ•°æ®é•¿åº¦ åŒ…å«æ•°æ®æœåŠ¡ */
 628   2              UDS.SID = LIN_data[2 + Startbyte]; /* æœåŠ¡id */
 629   2              UDS.DID = LIN_data[3 + Startbyte]; /* æ•°æ®id */
 630   2              UDS.N_Data[0] = LIN_data[5];
 631   2              UDS.N_Data[1] = LIN_data[6];
 632   2              UDS.N_Data[2] = LIN_data[7];
 633   2              UDS.N_DataFlow = 0;    /* è®¾ç½®å½“å‰çš„æ•°æ®æµç¼–å· */
 634   2              UDS.N_DataCount = 5;   /* è¿™é‡Œçš„SIDç®—ä¸€ä¸ªå­—èŠ‚æ‰€æœ‰ä»1å¼€å§‹è®¡æ•° */
 635   2              UDS.Flow_Mode = 1;     /* å¤šåŒ…æ•°æ®æµå¼€å§‹æ ‡å¿—ä½ */
 636   2              UDS.Flowlost_flag = 0; /* æ¸…é™¤ä¸¢åŒ…æ ‡å¿—ä½ */
 637   2              Service_Inquiry();     /* é¦–åŒ…ä¹Ÿè§£æä¸€ä¸‹ï¼Œé˜²æ­¢åé¢æ•°æ®ä¸¢å¤±å¯¼è‡´å›å¤å‚æ•°é”™è¯¯
             - */
 638   2              break;
 639   2      
 640   2              /***********0x20è¿ç»­å¸§æ•°æ®æµ 20-2F  å¤šåŒ…é¦–å¸§ä¹‹åè·Ÿéšçš„æ˜¯21***********/
 641   2          case 0x20:
 642   2              /* æ·»åŠ æ•°æ®æµç›‘æ§ä¿¡å·ä¿è¯æ•°æ®æµæ­£ç¡® ï¼Œä¸ç„¶ä¸­é—´ä¸¢åŒ…æ•°æ®æµå°±ä¸å¯¹äº† */
 643   2              UDS.N_DataFlow++;
 644   2              if (UDS.N_DataFlow > 0x0f)
 645   2              {
 646   3                  UDS.N_DataFlow = 0;
 647   3              }
 648   2              if ((UDS.N_DataFlow) != (Startdata & 0x0f)) /* æ•°æ®æµæ­£ç¡® */
 649   2              {
C51 COMPILER V9.60.0.0   MAIN                                                              04/10/2023 10:03:49 PAGE 12  

 650   3                  UDS.Flowlost_flag = 1; /* æ•°æ®æµä¸¢åŒ…æ ‡å¿— */
 651   3              }
 652   2      
 653   2              /* è¯»å–æœ‰æ•ˆæ•°æ® */
 654   2              for (i = 0; i < 6; i++) /* è¿ç»­å¸§æ¯åŒ…ä¼šæœ‰6ä¸ªæ•°æ®  */
 655   2              {
 656   3                  UDS.N_Data[UDS.N_DataCount - 2] = LIN_data[2 + i]; /* é‡‡é›†æ•°æ® */
 657   3                  UDS.N_DataCount++;                                 /* æ•°æ®è®°å½•ä½ç½®+1  */
 658   3              }
 659   2      
 660   2              /* æ•°æ®é‡‡é›†å®Œæˆå¼€å§‹å¤„ç†æ•°æ® */
 661   2              if (UDS.PCI <= (UDS.N_DataCount)) /* æ¥æ”¶æ•°æ®é•¿åº¦æ»¡è¶³æ•°æ®é•¿åº¦è¦æ±‚ */
 662   2              {
 663   3                  if (UDS.Flow_Mode == 1) /* æ•°æ®åŒ…æ²¡æœ‰ä¸¢å¤± ä¸”æ¥æ”¶å®Œæˆ */
 664   3                  {
 665   4                      UDS.Flow_Mode = 2; /* æ•°æ®æµæ¥æ”¶çŠ¶æ€ä¸ºæ¥æ”¶å®Œæˆ */
 666   4                      Service_Inquiry(); /* è¿›å…¥udsæœåŠ¡æŸ¥è¯¢å‡½æ•° */
 667   4                  }
 668   3                  else /* æ•°æ®åŒ…ä¸¢å¤± ä¸¢å¤±é¦–å¸§ */
 669   3                  {
 670   4                      UDS.N_DataCount = 0;
 671   4                      UDS.Flow_Mode = 0; /* æ•°æ®æµæ¥æ”¶çŠ¶æ€ä¸ºæ¥æ”¶æœªå®Œæˆï¼Œè¿”å›å¦å®šå‘å“åº” */
 672   4                      Service_Inquiry(); /* è¿›å…¥udsæœåŠ¡æŸ¥è¯¢å‡½æ•° */
 673   4                  }
 674   3              }
 675   2              break;
 676   2      
 677   2          case 0x30: /* æµæ§å¸§  linä¸æ”¯æŒæµæ§å¸§  */
 678   2      
 679   2              break;
 680   2      
 681   2          default:
 682   2              break;
 683   2          }
 684   1      }
 685          
 686          /* -------------------------------------------------------------------------------------------------
 687              Function Name  :  Service_Inquiry(void)
 688              Description    :  linæœåŠ¡æŸ¥è¯¢
 689              Date           : 2022-02-28
 690          ------------------------------------------------------------------------------------------------- */
 691          void Service_Inquiry(void)
 692          {
 693   1          switch (UDS.SID) /* æŸ¥è¯¢æœåŠ¡å‡½æ•°*/
 694   1          {
 695   2      
 696   2          case 0x10: /* è¿›å…¥ç¼–ç¨‹æ¨¡å¼ä¹‹åå›å¤æ•°æ®ä½¿ç”¨*/
 697   2              UDS_Srv10_Resp();
 698   2              break;
 699   2      
 700   2          case 0x27: /* è¿›å…¥å®‰å…¨è®¿é—®æ¨¡å¼è§£é”æ§åˆ¶å™¨ */
 701   2              UDS_Srv27_Resp();
 702   2              break;
 703   2      
 704   2          case 0x31: /* 1.åˆ é™¤appçš„ç¨‹åºä»£ç    2.æ£€æŸ¥æ•°æ®çš„æœ‰æ•ˆæ€§ï¼Œå¦‚CRCæ ¡éªŒ */
 705   2              UDS_Srv31_Resp();
 706   2              break;
 707   2      
 708   2          case 0x34: /* è®¾ç½®ä¸‹è½½èµ·å§‹åœ°å€å’Œå®½åº¦ï¼Œå¹¶å›ä¼ 36æœåŠ¡ä¸€æ¬¡å‘é€æœ€å¤§æ•°æ®å®½åº¦ */
 709   2              UDS_Srv34_Resp();
 710   2              break;
 711   2      
C51 COMPILER V9.60.0.0   MAIN                                                              04/10/2023 10:03:49 PAGE 13  

 712   2          case 0x36: /* è®¾ç½®ä¸‹è½½æ•°æ® å¤šåŒ…è¿ç»­å‘é€  */
 713   2              UDS_Srv36_Resp();
 714   2              break;
 715   2      
 716   2          case 0x37: /* è®¾ç½®ä¸‹è½½å®Œæˆé€€å‡ºä¸‹è½½  */
 717   2              UDS_Srv37_Resp();
 718   2              break;
 719   2      
 720   2          case 0x11: /* æ§åˆ¶å™¨å¤ä½ */
 721   2              UDS_Srv11_Resp();
 722   2              break;
 723   2      
 724   2          case 0x19: /* æ§åˆ¶å™¨æŸ¥è¯¢ */
 725   2              UDS_Srv19_Resp();
 726   2              break;
 727   2          default:
 728   2              break;
 729   2          }
 730   1      }
 731          /* æœåŠ¡å‡½æ•° */
 732          
 733          /*
 734          **********************************************************************************************************
             -***************************************************************************
 735          @   Brief    ï¼šService $10 -- è¿›å…¥æ‰©å±•æ¨¡å¼(10æœåŠ¡)
 736          @   Param    ï¼š3ä¸ªå­åŠŸèƒ½ï¼Œ01 Defaulté»˜è®¤ä¼šè¯ï¼Œ02 Programmingç¼–ç¨‹ä¼šè¯ï¼Œ03 Extendedæ‰©å±•ä¼š
             -è¯ï¼ŒECUä¸Šç”µæ—¶ï¼Œè¿›å…¥çš„æ˜¯é»˜è®¤ä¼šè¯ï¼ˆDefaultï¼‰
 737          @    Date    ï¼š2022 - 02 - 11
 738          **********************************************************************************************************
             -****************************************************************************
 739          */
 740          uint8 UDS_Srv10_Resp(void)
 741          {
 742   1      
 743   1          LINReply.PCI = 0x02;           /* å›å¤æ•°æ®é•¿åº¦ */
 744   1          LINReply.NAD = MNAD;           /* å›å¤æ•°æ®è®¾ç½® */
 745   1          LINReply.SID = UDS.SID + 0x40; /* å›å¤æ•°æ®ID */
 746   1          LINReply.DATA[0] = UDS.DID;    /* P2Server_max:é«˜å­—èŠ‚value: 50 ms */
 747   1          LINReply.NRSID = 0x00;         /* å›å¤æ•°æ®åŒ…æ•° */
 748   1          switch (UDS.DID)
 749   1          {
 750   2          case 0x01:           /* Defaulté»˜è®¤ä¼šè¯ */
 751   2              USER.P_flag = 0; /* ç¼–ç¨‹æ ‡å¿—ç¦æ­¢ */
 752   2              break;
 753   2      
 754   2          case 0x02: /* Programmingç¼–ç¨‹ä¼šè¯ */
 755   2              if (USER.Reset_flag == 0)
 756   2                  USER.P_flag = 1; /* ç¼–ç¨‹æ ‡å¿—å…è®¸ */
 757   2              break;
 758   2      
 759   2          case 0x03:           /* Extendedæ‰©å±•ä¼šè¯  bootä¸ä¼šä½¿ç”¨æ­¤æ¨¡å¼*/
 760   2              USER.P_flag = 0; /* ç¼–ç¨‹æ ‡å¿—ç¦æ­¢ */
 761   2              break;
 762   2      
 763   2          default:
 764   2              LINReply.PCI = 0x03;          /* å›å¤æ•°æ®é•¿åº¦ */
 765   2              LINReply.NRSID = 0x7f;        /* å›å¤æ•°æ®é•¿åº¦ */
 766   2              LINReply.SID = 0x10;          /* å›å¤æ•°æ®ID */
 767   2              LINReply.ErrorCode = UDS.DID; /* ä¸æ”¯æŒçš„æœåŠ¡ */
 768   2              break;
 769   2          }
 770   1          return 0;
C51 COMPILER V9.60.0.0   MAIN                                                              04/10/2023 10:03:49 PAGE 14  

 771   1      }
 772          
 773          /*
 774          **********************************************************************************************************
             -***************************************************************************
 775          @   Brief    ï¼šService $11 -- ECUå¤ä½ (11æœåŠ¡)
 776          @   Param    ï¼š3ä¸ªå­åŠŸèƒ½ï¼Œ01 hardReset ç¡¬å¤ä½ï¼Œ02 softResetï¼Œ
 777          @    Date    ï¼š2022 - 02 - 11
 778          **********************************************************************************************************
             -****************************************************************************
 779          */
 780          uint8 UDS_Srv11_Resp(void)
 781          {
 782   1      
 783   1          LINReply.PCI = 0x02;           /* å›å¤æ•°æ®é•¿åº¦ */
 784   1          LINReply.NAD = MNAD;           /* å›å¤æ•°æ®è®¾ç½® */
 785   1          LINReply.SID = UDS.SID + 0x40; /* å›å¤æ•°æ®ID */
 786   1          LINReply.DATA[0] = UDS.DID;    /* P2Server_max:é«˜å­—èŠ‚value: 50 ms */
 787   1          LINReply.NRSID = 0x00;         /* å›å¤æ•…éšœæ¸…ç©º */
 788   1      
 789   1          switch (UDS.DID)
 790   1          {
 791   2          case 0x01:               /* hardReset ç¡¬å¤ä½*/
 792   2              USER.Reset_flag = 1; /* å¤ä½ */
 793   2              break;
 794   2      
 795   2          case 0x02:               /* softReset */
 796   2              USER.Reset_flag = 1; /* å¤ä½ */
 797   2              break;
 798   2      
 799   2          default:
 800   2              LINReply.PCI = 0x03;          /* å›å¤æ•°æ®é•¿åº¦ */
 801   2              LINReply.NRSID = 0x7f;        /* å›å¤æ•°æ®é•¿åº¦ */
 802   2              LINReply.SID = UDS.SID;       /* å›å¤æ•°æ®ID */
 803   2              LINReply.ErrorCode = UDS.DID; /* ä¸æ”¯æŒçš„æœåŠ¡ */
 804   2              break;
 805   2          }
 806   1          return 0;
 807   1      }
 808          
 809          /*
 810          **********************************************************************************************************
             -***************************************************************************
 811          @   Brief    ï¼šService $27 -- ECUè§£é”  (27æœåŠ¡)
 812          @   Param    ï¼šUDS.DIDéƒ½æ˜¯å¥‡æ•°ï¼Œå¯¹åº”ä¸åŒçš„æƒé™ ã€‚ å›å¤çš„didä¸ºç°æœ‰did+1
 813          @    Date    ï¼š2022 - 02 - 11
 814          **********************************************************************************************************
             -****************************************************************************
 815          */
 816          uint8 UDS_Srv27_Resp(void)
 817          {
 818   1      
 819   1          LINReply.PCI = 0x06;            /* å›å¤æ•°æ®é•¿åº¦ */
 820   1          LINReply.NAD = MNAD;            /* å›å¤æ•°æ®è®¾ç½® */
 821   1          LINReply.SID = UDS.SID + 0x40;  /* å›å¤æ•°æ®ID */
 822   1          LINReply.DATA[0] = UDS.DID + 1; /* å›å¤æ•°æ®DID */
 823   1          LINReply.NRSID = 0x00;          /* å›å¤æ•…éšœæ¸…ç©º */
 824   1      
 825   1          switch (UDS.DID)
 826   1          {
 827   2          case 0x01: /* ç¼–ç¨‹åªè¦è§£é”01 å°±å¯ä»¥*/
 828   2              if ((UDS.N_Data[0] == PARA1) && (UDS.N_Data[1] == PARA2) && (UDS.N_Data[2] == PARA3) && (UDS.N_Dat
C51 COMPILER V9.60.0.0   MAIN                                                              04/10/2023 10:03:49 PAGE 15  

             -a[3] == PARA4) && (USER.P_flag == 1))
 829   2              {
 830   3                  LINReply.DATA[1] = KEY1; /*  */
 831   3                  LINReply.DATA[2] = KEY2; /*  */
 832   3                  LINReply.DATA[3] = KEY3; /*  */
 833   3                  LINReply.DATA[4] = KEY4; /*  */
 834   3                  USER.P_flag = 2;         /* è§£é”æˆåŠŸ */
 835   3              }
 836   2              else
 837   2              {
 838   3                  LINReply.PCI = 0x03;          /* å›å¤æ•°æ®é•¿åº¦ */
 839   3                  LINReply.NRSID = 0x7f;        /* å›å¤æ•°æ®é•¿åº¦ */
 840   3                  LINReply.SID = UDS.SID;       /* å›å¤æ•°æ®ID */
 841   3                  LINReply.ErrorCode = UDS.DID; /* å¦å®šå›å¤ */
 842   3              }
 843   2              break;
 844   2      
 845   2          case 0x03: /* softReset */
 846   2              if ((UDS.N_Data[0] == 0X44) && (UDS.N_Data[1] == 0X55) && (UDS.N_Data[2] == 0X66))
 847   2              {
 848   3                  USER.KEY_flag = 1;       /* è§£é”æˆåŠŸ */
 849   3                  LINReply.DATA[1] = KEY1; /*  */
 850   3                  LINReply.DATA[2] = KEY2; /*  */
 851   3                  LINReply.DATA[3] = KEY3; /*  */
 852   3                  LINReply.DATA[4] = KEY4; /*  */
 853   3              }
 854   2              else
 855   2              {
 856   3                  LINReply.PCI = 0x03;          /* å›å¤æ•°æ®é•¿åº¦ */
 857   3                  LINReply.NRSID = 0x7f;        /* å›å¤æ•°æ®é•¿åº¦ */
 858   3                  LINReply.SID = UDS.SID;       /* å›å¤æ•°æ®ID */
 859   3                  LINReply.ErrorCode = UDS.DID; /* å¦å®šå›å¤ */
 860   3              }
 861   2              break;
 862   2      
 863   2          default:
 864   2              LINReply.PCI = 0x03;          /* å›å¤æ•°æ®é•¿åº¦ */
 865   2              LINReply.NRSID = 0x7f;        /* å›å¤æ•°æ®é•¿åº¦ */
 866   2              LINReply.SID = UDS.SID;       /* å›å¤æ•°æ®ID */
 867   2              LINReply.ErrorCode = UDS.DID; /* å¦å®šå›å¤ */
 868   2              break;
 869   2          }
 870   1          return 0;
 871   1      }
 872          
 873          /*
 874          **********************************************************************************************************
             -***************************************************************************
 875          @   Brief    ï¼šService $31 -- åˆ é™¤å­˜å‚¨ç©ºé—´ ,å’Œ CRCæ ¡éªŒ
 876          @   Param    ï¼šå•åŒ…æ•°æ®ï¼Œ é€€å‡ºæ•°æ®æœåŠ¡åå°±å¼€å§‹è®¡ç®—crc
 877          @    Date    ï¼š2022 - 02 - 11
 878          **********************************************************************************************************
             -****************************************************************************
 879          */
 880          uint8 UDS_Srv31_Resp(void)
 881          {
 882   1      
 883   1          uint16 CRC16;
 884   1          LINReply.PCI = 0x04;           /* å›å¤æ•°æ®é•¿åº¦ */
 885   1          LINReply.NAD = MNAD;           /* å›å¤æ•°æ®è®¾ç½® */
 886   1          LINReply.SID = UDS.SID + 0x40; /* å›å¤æ•°æ®ID */
 887   1          LINReply.DATA[0] = UDS.DID;    /* å›å¤æ•°æ®DID */
C51 COMPILER V9.60.0.0   MAIN                                                              04/10/2023 10:03:49 PAGE 16  

 888   1          LINReply.DATA[1] = UDS.N_Data[0];
 889   1          LINReply.DATA[2] = UDS.N_Data[1];
 890   1          LINReply.NRSID = 0x00; /* å›å¤æ•…éšœæ¸…ç©º */
 891   1      
 892   1          switch (UDS.DID)
 893   1          {
 894   2          case 0x01:
 895   2              if ((UDS.N_Data[0] == RIEFM1) && (UDS.N_Data[1] == RIEFM2) && (USER.P_flag == 2)) /* å¯¹æ¯”routine
             -Identifier */
 896   2              {
 897   3                  USER.Erase_flag = 1; /* æ“¦é™¤flash æ ‡å¿—ä½ç½®ä¸€ */
 898   3                  USER.P_flag = 3;
 899   3              }
 900   2              else if ((UDS.N_Data[0] == RICRC1) && (UDS.N_Data[1] == RICRC2)) /* å¯¹æ¯”routineIdentifier */
 901   2              {
 902   3                  Flash_CRC_APP(USER.MemoryAddress,USER.MemorySize); /* CRC æ ¡éªŒ */
 903   3                  if ((UDS.N_Data[2] == CRCL) && (UDS.N_Data[3] == CRCH))
 904   3                  {
 905   4                      LINReply.PCI = 0x06; /* å›å¤æ•°æ®é•¿åº¦ */
 906   4                      LINReply.DATA[3] = CRCL;
 907   4                      LINReply.DATA[4] = CRCH;
 908   4                      Flash_Sector_Write(GOTO_MAIN+3, CRCL); //å†™å…¥CRC
 909   4                      Flash_Sector_Write(GOTO_MAIN+4, CRCH); //å†™å…¥CRC
 910   4                      Flash_Sector_Write(GOTO_MAIN, 0xaa); //bootå®Œæˆæ ‡è®°
 911   4                
 912   4                  }
 913   3                  else
 914   3                  {
 915   4                      LINReply.PCI = 0x03;          /* å›å¤æ•°æ®é•¿åº¦ */
 916   4                      LINReply.NRSID = 0x7f;        /* å›å¤æ•°æ®é•¿åº¦ */
 917   4                      LINReply.SID = UDS.SID;       /* å›å¤æ•°æ®ID */
 918   4                      LINReply.ErrorCode = UDS.DID; /* å¦å®šå›å¤ */
 919   4                  }
 920   3              }
 921   2              else
 922   2              {
 923   3                  LINReply.PCI = 0x03;          /* å›å¤æ•°æ®é•¿åº¦ */
 924   3                  LINReply.NRSID = 0x7f;        /* å›å¤æ•°æ®é•¿åº¦ */
 925   3                  LINReply.SID = UDS.SID;       /* å›å¤æ•°æ®ID */
 926   3                  LINReply.ErrorCode = UDS.DID; /* å¦å®šå›å¤ */
 927   3              }
 928   2              break;
 929   2      
 930   2          case 0x02: /* åœæ­¢ç¨‹åº*/
 931   2      
 932   2              break;
 933   2      
 934   2          case 0x03: /* åœæ­¢ç¨‹åº*/
 935   2      
 936   2              break;
 937   2      
 938   2          default:                          /* NCR */
 939   2              LINReply.PCI = 0x03;          /* å›å¤æ•°æ®é•¿åº¦ */
 940   2              LINReply.NRSID = 0x7f;        /* å›å¤æ•°æ®é•¿åº¦ */
 941   2              LINReply.SID = UDS.SID;       /* å›å¤æ•°æ®ID */
 942   2              LINReply.ErrorCode = UDS.DID; /* å¦å®šå›å¤ */
 943   2              break;
 944   2          }
 945   1          return 0;
 946   1      }
 947          
 948          /*
C51 COMPILER V9.60.0.0   MAIN                                                              04/10/2023 10:03:49 PAGE 17  

 949          **********************************************************************************************************
             -***************************************************************************
 950          @   Brief    ï¼šService $34 -- ä¸‹è½½è¯·æ±‚  (34æœåŠ¡)
 951          @   Param    ï¼šæ­¤å¤„æ˜¯å¤šåŒ…æ•°æ®ï¼Œéœ€è¦æ³¨æ„
 952          @    Date    ï¼š2022 - 01 - 11
 953          **********************************************************************************************************
             -****************************************************************************
 954          */
 955          uint8 UDS_Srv34_Resp(void)
 956          {
 957   1          uint8 len, i;
 958   1          if ((UDS.Flow_Mode == 2) && (USER.P_flag == 3)) /* æ•°æ®æ¥æ”¶å®Œæˆ */
 959   1          {
 960   2              LINReply.PCI = 0x03;           /* å›å¤æ•°æ®é•¿åº¦ */
 961   2              LINReply.NAD = MNAD;           /* å›å¤æ•°æ®è®¾ç½® */
 962   2              LINReply.SID = UDS.SID + 0x40; /* å›å¤æ•°æ®ID */
 963   2              LINReply.DATA[0] = LFID;       /* å›å¤æ•°æ®DID */
 964   2              LINReply.DATA[1] = Block_Len;  /* å›å¤æ•°æ®DID */
 965   2              LINReply.NRSID = 0x00;         /* å›å¤æ•…éšœæ¸…ç©º */
 966   2      
 967   2              /* if (UDS.N_Data[0] == 0)  åŠ å¯†å‹ç¼©ä¿¡æ¯,æœªä½¿ç”¨
 968   2               {
 969   2                   ;
 970   2               }*/
 971   2              USER.MemoryAddress = 0; /* æ¸…ç©ºåœ°å€å’Œæ•°æ®é•¿åº¦ */
 972   2              USER.MemorySize = 0;    /* æ¸…ç©ºåœ°å€å’Œæ•°æ®é•¿åº¦ */
 973   2              USER.WriteAddress = 0;
 974   2              len = UDS.N_Data[0] & 0x0f; /* MemoryAddress æ‰€å å­—èŠ‚çš„é•¿åº¦*/
 975   2              for (i = 0; i < len; i++)
 976   2              {
 977   3                  USER.MemoryAddress = USER.MemoryAddress + (uint32)(UDS.N_Data[i + 1] << ((len - 1 - i) * 8));
 978   3              }
 979   2              len = (UDS.N_Data[0] >> 4) & 0xf; /* memorySize æ‰€å å­—èŠ‚çš„é•¿åº¦*/
 980   2              for (i = 0; i < len; i++)
 981   2              {
 982   3                  USER.MemorySize = USER.MemorySize + (uint32)(UDS.N_Data[i + 5] << ((len - 1 - i) * 8));
 983   3              }
 984   2              LINReply.BSC = 0;     /* é‡ç½®36çš„åŒ…åºå· */
 985   2              UDS.BSC_ERR_flag = 0; /* é‡ç½®36é”™è¯¯æ ‡å¿—ä½ */
 986   2              USER.P_flag = 4;      /* è¿›å…¥ä¸‹ä¸€æ­¥éª¤ï¼Œåé¢å¦‚æœåˆ¤æ–­çš„*/
 987   2          }
 988   1          else
 989   1          {
 990   2              LINReply.PCI = 0x03;       /* å›å¤æ•°æ®é•¿åº¦ */
 991   2              LINReply.NRSID = 0x7f;     /* å›å¤æ•°æ®é•¿åº¦ */
 992   2              LINReply.SID = UDS.SID;    /* å›å¤æ•°æ®ID */
 993   2              LINReply.ErrorCode = 0x13; /* æ•°æ®é•¿åº¦ä¸ä¸€è‡´å‡ºç°ä¸¢åŒ… */
 994   2          }
 995   1      
 996   1          if (UDS.Flowlost_flag || (FLAG_BASE > USER.MemoryAddress) || (FLAG_SIZE < USER.MemorySize)) /* å‡ºç°æ
             -•°æ®ä¸¢å¤±ç°è±¡ */
 997   1          {
 998   2              LINReply.PCI = 0x03;    /* å›å¤æ•°æ®é•¿åº¦ */
 999   2              LINReply.NRSID = 0x7f;  /* å›å¤æ•°æ®é•¿åº¦ */
1000   2              LINReply.SID = UDS.SID; /* å›å¤æ•°æ®ID */
1001   2              if (UDS.Flowlost_flag)
1002   2              {
1003   3                  LINReply.ErrorCode = 0x13; /* å¦å®šå›å¤ é•¿åº¦é”™è¯¯ */
1004   3              }
1005   2              else
1006   2              {
1007   3                  LINReply.ErrorCode = 0x22; /* å¦å®šå›å¤ æ‰§è¡Œæ¡ä»¶ä¸æ»¡è¶³ */
C51 COMPILER V9.60.0.0   MAIN                                                              04/10/2023 10:03:49 PAGE 18  

1008   3                  USER.P_flag = 3;
1009   3              }
1010   2          }
1011   1          return 0;
1012   1      }
1013          /*
1014          **********************************************************************************************************
             -***************************************************************************
1015          @   Brief    ï¼šService $36 -- ECUæ•°æ®ä¼ è¾“  (36æœåŠ¡)
1016          @   Param    ï¼šæ­¤å¤„æ˜¯å¤šåŒ…æ•°æ®ï¼Œéœ€è¦æ³¨æ„
1017          @    Date    ï¼š2022 - 02 - 11
1018          **********************************************************************************************************
             -****************************************************************************
1019          */
1020          uint8 UDS_Srv36_Resp(void)
1021          {
1022   1          if (UDS.Flow_Mode == 2) /* æ•°æ®æ¥æ”¶å®Œæˆ */
1023   1          {
1024   2              LINReply.NAD = MNAD;           /* å›å¤æ•°æ®è®¾ç½® */
1025   2              LINReply.PCI = 0x02;           /* å›å¤æ•°æ®é•¿åº¦ */
1026   2              LINReply.SID = UDS.SID + 0x40; /* å›å¤æ•°æ®ID */
1027   2              LINReply.DATA[0] = UDS.DID;    /* å›å¤æ•°æ®BSC é¦–åŒ…è®¡æ•°å™¨  */
1028   2              LINReply.NRSID = 0x00;         /* å›å¤æ•…éšœæ¸…ç©º */
1029   2      
1030   2              if (((LINReply.BSC + 1) & 0Xff) != LINReply.DATA[0])
1031   2              {
1032   3                  UDS.BSC_ERR_flag = 1; /* BSCæ•°æ®å—é”™è¯¯ */
1033   3              }
1034   2              else
1035   2              {
1036   3                  LINReply.BSC = LINReply.DATA[0]; /* èµ‹å€¼bscè®¡æ•°å™¨ ç”¨äºä¸‹æ¬¡è®¡ç®—*/
1037   3              }
1038   2      
1039   2              if ((!UDS.BSC_ERR_flag) && (!UDS.Flowlost_flag) && (USER.P_flag == 4)) /* BSCæ•°æ®å—æ²¡æœ‰é”™è¯¯
             -,å¤šåŒ…æ•°æ®æ²¡æœ‰ä¸¢å¤± */
1040   2              {
1041   3                  Write64Byte64Flash(USER.MemoryAddress + USER.WriteAddress, UDS.N_Data, (UDS.PCI - 2)); /* å‘f
             -lashå†™å…¥64å­—èŠ‚æ•°æ® */
1042   3                  USER.WriteAddress = USER.WriteAddress + (UDS.PCI - 2);                                 /* è®¡æ
             -•°åœ°å€å‘åå¢åŠ  */
1043   3              }
1044   2          }
1045   1      
1046   1          /**********************å¦å®šå›å¤ ********************* */
1047   1          if ((UDS.Flowlost_flag) || (UDS.BSC_ERR_flag)) /* å‡ºç°æ•°æ®ä¸¢å¤±ç°è±¡ */
1048   1          {
1049   2              LINReply.PCI = 0x03;          /* å›å¤æ•°æ®é•¿åº¦ */
1050   2              LINReply.NRSID = 0x7f;        /* å›å¤æ•°æ®é•¿åº¦ */
1051   2              LINReply.SID = UDS.SID;       /* å›å¤æ•°æ®ID */
1052   2              LINReply.ErrorCode = UDS.DID; /* å¦å®šå›å¤ */
1053   2              if (UDS.BSC_ERR_flag)
1054   2              {
1055   3                  LINReply.ErrorCode = 0x73;
1056   3              }
1057   2          }
1058   1          return 0;
1059   1      }
1060          /*
1061          **********************************************************************************************************
             -***************************************************************************
1062          @   Brief    ï¼šService $37 -- ç»“æŸæ•°æ®ä¼ è¾“ (37æœåŠ¡)
1063          @   Param    ï¼šå•åŒ…æ•°æ®ï¼Œ
C51 COMPILER V9.60.0.0   MAIN                                                              04/10/2023 10:03:49 PAGE 19  

1064          @    Date    ï¼š2022 - 01 - 11
1065          **********************************************************************************************************
             -****************************************************************************
1066          */
1067          uint8 UDS_Srv37_Resp(void)
1068          {
1069   1          LINReply.NAD = MNAD;           /* å›å¤æ•°æ®è®¾ç½® */
1070   1          LINReply.PCI = 0x01;           /* å›å¤æ•°æ®é•¿åº¦ */
1071   1          LINReply.SID = UDS.SID + 0x40; /* å›å¤æ•°æ®ID */
1072   1          LINReply.NRSID = 0x00;         /* å›å¤æ•…éšœæ¸…ç©º */
1073   1      
1074   1          return 0;
1075   1      }
1076          /*
1077          **********************************************************************************************************
             -***************************************************************************
1078          @   Brief    ï¼šService $19 -- è¯»å–ecuæ•…éšœæ€»æ•° (19æœåŠ¡)
1079          @   Param    ï¼šå•åŒ…æ•°æ®ï¼Œ é€€å‡ºæ•°æ®æœåŠ¡åå°±å¼€å§‹è®¡ç®—crc
1080          @    Date    ï¼š2022 - 01 - 11
1081          **********************************************************************************************************
             -****************************************************************************
1082          */
1083          uint8 UDS_Srv19_Resp(void)
1084          {
1085   1          uint16 ERRcont = 0;
1086   1          uint8 i = 0;
1087   1          LINReply.NAD = MNAD;           /* å›å¤æ•°æ®è®¾ç½® */
1088   1          LINReply.PCI = 0x06;           /* å›å¤æ•°æ®é•¿åº¦ */
1089   1          LINReply.SID = UDS.SID + 0x40; /* å›å¤æ•°æ®ID */
1090   1          LINReply.DATA[0] = UDS.DID;    /* å›å¤æ•°æ®DID */
1091   1      
1092   1          LINReply.DATA[1] = 0xff; /* å¯ç”¨çŠ¶æ€æ©ç  */
1093   1          LINReply.DATA[2] = 0x01; /* 14229-1 */
1094   1      
1095   1          /* ä»æŒ‡å®šçš„flashä¸­è¯»å–æ•…éšœæ•°é‡ å€’åºæŸ¥è¯¢
1096   1          for (i = 128; i == 0; i--)
1097   1          {
1098   1              LINReply.DATA[3] = *(uint8 code *)(ERRADDR + ((i - 1) * 2));
1099   1              LINReply.DATA[4] = *(uint8 code *)(ERRADDR + ((i - 1) * 2) + 1);
1100   1              if (LINReply.DATA[3] || LINReply.DATA[4])//æ£€æµ‹åˆ°éé›¶æ•°å€¼é€€å‡º
1101   1              {
1102   1                  i = 0;
1103   1              }
1104   1          }*/
1105   1          LINReply.DATA[3] = 0X01; /* æ•…éšœæ•°é«˜ä½ */
1106   1          LINReply.DATA[4] = 0X02; /* æ•…éšœæ•°ä½ä½ */
1107   1          /* ä»æŒ‡å®šçš„flashä¸­è¯»å–æ•…éšœæ•°é‡ */
1108   1      
1109   1          if ((UDS.N_Data[0] != 0x01) || (UDS.DID != 0x01))
1110   1          {
1111   2              LINReply.NRSID = 0x00;     /* å›å¤æ•…éšœæ¸…ç©º */
1112   2              LINReply.PCI = 0x03;       /* å›å¤æ•°æ®é•¿åº¦ */
1113   2              LINReply.NRSID = 0x7f;     /* å›å¤æ•°æ®é•¿åº¦ */
1114   2              LINReply.SID = UDS.SID;    /* å›å¤æ•°æ®ID */
1115   2              LINReply.ErrorCode = 0x01; /* æ•°æ®é•¿åº¦ä¸ä¸€è‡´å‡ºç°ä¸¢åŒ… */
1116   2          }
1117   1      }
1118          /*  -------------------------------------------------------------------------------------------------
1119              Function Name  : LIN_send
1120              Description    : linæ•°æ®å‘é€
1121              Date           :
1122                             : [è¾“å…¥]
C51 COMPILER V9.60.0.0   MAIN                                                              04/10/2023 10:03:49 PAGE 20  

1123              ------------------------------------------------------------------------------------------------- */
1124          void LIN_Resp(void)
1125          {
1126   1          if ((Lin.Send_flag) && (!Lin.Sleep_flag)) /* linå‘é€æ—¶é—´è¾ƒé•¿4.5msï¼Œä¸æ”¾å…¥ä¸­æ–­ */
1127   1          {
1128   2              Lin.Check = LinCheck(1, Lin.PID, Lin.Leng, &Lin.SData); /* è®¡ç®—éœ€è¦å‘é€çš„æ ¡éªŒå’Œ */
1129   2              LIN_Send(&Lin.SData, Lin.Check, Lin.Leng);              /* å‘é€æ•°æ® */
1130   2              Cutover_IO();                                           /* å‘é€å®Œæˆæ•°æ® å¼€å§‹è¿”å›åˆ°ç«¯å
             -£æ£€æµ‹ */
1131   2              Lin.Send_flag = 0;                                      /* å‘é€æ ‡å¿—ä½ç½® */
1132   2              if ((Lin.SData[2] == 0X71) && (USER.Erase_flag == 1))
1133   2              {
1134   3                  Flash_Erase_APP(); /* å›å¤å®Œæˆåæ“¦é™¤ç©ºé—´ */
1135   3                  USER.Erase_flag = 0;
1136   3              }
1137   2      
1138   2              if ((Lin.SData[2] == 0X51) && (USER.Reset_flag))
1139   2              {
1140   3            Flash_CRC_APP(PADDR,CRCSize); /* CRC æ ¡éªŒ */
1141   3            Flash_Sector_Write(CRCL_ADD, CRCL); //å†™å…¥CRC
1142   3            Flash_Sector_Write(CRCH_ADD, CRCH); //å†™å…¥CRC
1143   3                  (*(void (*)())PADDR)();  /* å›å¤å®Œæˆè·³è½¬ä¸»ç¨‹åº */
1144   3                  USER.Reset_flag=0;
1145   3              }
1146   2          }
1147   1      }
1148          /*-------------------------------------------------------------------------------------------------
1149              Function Name : void LIN_list(uint8 PID)
1150              Description   : æ€»çº¿æ”¶å‘åˆ—è¡¨ ï¼Œå¯¹æ¥æ”¶çš„æ•°æ®è®¾ç½®é•¿åº¦å’Œæ£€éªŒç±»å‹ ã€‚å¯¹å‘é€çš„æ•°
             -æ®è®¾ç½®
1151              Input         : è¦å‘é€çš„å­—ç¬¦ä¸²çš„åœ°å€
1152              Output      : æ— 
1153          -------------------------------------------------------------------------------------------------*/
1154          void LIN_list(uint8 PID)
1155          {
1156   1          static uint16 addr = 0x1000;
1157   1      
1158   1          uint8 i = 0;
1159   1      
1160   1          uint8 LIN_ID1 = 0;
1161   1          Lin.Count = 0; /* æ¸…ç©ºè®¡æ•° */
1162   1      
1163   1          switch (PID)
1164   1          {
1165   2          case 0x3C:
1166   2              Lin.RUN_flag = 13; /* æ ¹æ®æ•°æ®å¤´åˆ¤æ–­æ˜¯æ¥æ”¶æ•°æ®  LIN_flag = 3 ï¼Œå‘é€æ•°æ® ï¼Œä¸éœ€
             -è¦å›åº”æ•°æ® */
1167   2              Lin.Leng = 8;      /* å¡«å†™éœ€è¦æ¥æ”¶çš„æ•°æ®é•¿åº¦ */
1168   2              addr = 0x1000;
1169   2              break;
1170   2      
1171   2          case 0x7d:
1172   2              Lin.RUN_flag = 23; /* æ ¹æ®æ•°æ®å¤´åˆ¤æ–­æ˜¯æ¥æ”¶æ•°æ®  LIN_flag = 3 ï¼Œå‘é€æ•°æ® ï¼Œä¸éœ€
             -è¦å›åº”æ•°æ® */
1173   2              Lin.Leng = 8;      /* å¡«å†™éœ€è¦æ¥æ”¶çš„æ•°æ®é•¿åº¦ */
1174   2              addr = 0x1100;
1175   2              for (i = 0; i < 8; i++)
1176   2              {
1177   3                  Lin.SData[i] = Unusedbyte; /* æ¸…ç©ºæ•°ç»„ */
1178   3              }
1179   2      
1180   2              Lin.SData[0] = LINReply.NAD;
C51 COMPILER V9.60.0.0   MAIN                                                              04/10/2023 10:03:49 PAGE 21  

1181   2              Lin.SData[1] = LINReply.PCI;
1182   2              if (LINReply.NRSID) /* å¦å®šå“åº” */
1183   2              {
1184   3                  Lin.SData[2] = LINReply.NRSID;
1185   3                  Lin.SData[3] = LINReply.SID;
1186   3                  Lin.SData[4] = LINReply.ErrorCode;
1187   3              }
1188   2              else
1189   2              {
1190   3                  Lin.SData[2] = LINReply.SID;
1191   3                  if (LINReply.PCI >= 2)
1192   3                      Lin.SData[3] = LINReply.DATA[0];
1193   3                  if (LINReply.PCI >= 3)
1194   3                      Lin.SData[4] = LINReply.DATA[1];
1195   3                  if (LINReply.PCI >= 4)
1196   3                      Lin.SData[5] = LINReply.DATA[2];
1197   3                  if (LINReply.PCI >= 5)
1198   3                      Lin.SData[6] = LINReply.DATA[3];
1199   3                  if (LINReply.PCI >= 6)
1200   3                      Lin.SData[7] = LINReply.DATA[4];
1201   3              }
1202   2              Lin.Send_flag = 1;
1203   2              break;
1204   2      
1205   2          case 0xFB:             /* å¯ä»¥åˆ é™¤ä¼˜åŒ–ç©ºé—´ */
1206   2              Lin.RUN_flag = 23; /* æ ¹æ®æ•°æ®å¤´åˆ¤æ–­æ˜¯æ¥æ”¶æ•°æ®  LIN_flag = 3 ï¼Œå‘é€æ•°æ® ï¼Œä¸éœ€
             -è¦å›åº”æ•°æ® */
1207   2              Lin.Leng = 8;      /* å¡«å†™éœ€è¦æ¥æ”¶çš„æ•°æ®é•¿åº¦ */
1208   2              for (i = 0; i < 8; i++)
1209   2              {
1210   3                  Lin.SData[i] = *(uint8 code *)(addr);
1211   3                  addr++;
1212   3              }
1213   2              Lin.Send_flag = 1;
1214   2              break;
1215   2          
1216   2      //  case 0xf0:             /* å¯ä»¥åˆ é™¤ä¼˜åŒ–ç©ºé—´ */
1217   2      //        Lin.RUN_flag = 23; /* æ ¹æ®æ•°æ®å¤´åˆ¤æ–­æ˜¯æ¥æ”¶æ•°æ®  LIN_flag = 3 ï¼Œå‘é€æ•°æ® ï¼Œä¸é
             -œ€è¦å›åº”æ•°æ® */
1218   2      //        Lin.Leng = 8;      /* å¡«å†™éœ€è¦æ¥æ”¶çš„æ•°æ®é•¿åº¦ */
1219   2      //        for (i = 0; i < 8; i++)
1220   2      //        {
1221   2      //            Lin.SData[0] = 8;
1222   2      //      Lin.SData[1] = CRCH;
1223   2      //      Lin.SData[2] = CRCL;
1224   2      //        }
1225   2      //        Lin.Send_flag = 1;
1226   2      //        break;
1227   2      
1228   2          default:
1229   2              Cutover_IO();
1230   2              break;
1231   2          }
1232   1      }
1233          void main(void)
1234          {
1235   1          unsigned char ucDelay;
1236   1          for (ucDelay = 0; ucDelay < 200; ucDelay--)
1237   1          {
1238   2              ;
1239   2          }   
1240   1          /* 
C51 COMPILER V9.60.0.0   MAIN                                                              04/10/2023 10:03:49 PAGE 22  

1241   1          GOTO_MAINæ˜¯BOOTå†™å®Œæ•°æ®å¹¶æ ¡éªŒåå†™å…¥çš„æ ‡å¿—ï¼Œ 
1242   1          MAIN_NO_ENPTYæ˜¯appè¿è¡Œåå†™å…¥çš„æ ‡å¿— ï¼Œï¼ˆMAIN_NO_ENPTYå»ºè®®æ”¾åˆ°ä¸­æ–­ä¸­ï¼Œä¿è¯è·³è½¬å
             -ä¸­æ–­æ­£å¸¸ï¼‰
1243   1          */
1244   1        Flash_CRC_APP(PADDR,CRCSize); /*  app CRC æ ¡éªŒ */
1245   1         /* è°ƒè¯•ä¸Šä½æœºç¦æ­¢è·³è½¬,è°ƒè¯•å¯ä»¥å…³é—­è·³è½¬ */
1246   1          if (*(unsigned char code *)GOTO_MAIN && *(unsigned char code *)MAIN_NO_ENPTY)
1247   1          {
1248   2          if((CRCH==*(unsigned char code *)CRCH_ADD)&&((CRCL==*(unsigned char code *)CRCL_ADD)))/*  appä»£ç æ ¡éª
             -ŒåŒ¹é… */
1249   2          {
1250   3          (*(void (*)())PADDR)(); /* è·³è½¬å‡½æ•°  */ 
1251   3          }
1252   2              
1253   2          }
1254   1          MNAD = *(uint8 code *)(NAD_ADD);
1255   1          ;
1256   1          WDT_ARR = ((uint16)(65532-(uint32)WDTtime*32768/1000) >> 8);   /* åˆå§‹åŒ–çœ‹é—¨ç‹— */
1257   1          MODE_IO();
1258   1          TIM3_Init();
1259   1        
1260   1        SetBit(P3_OE, PIN4); /*è¾“å…¥æ¨¡å¼*/
1261   1        ClrBit(P3_PU, PIN4); /*ä¸Šæ‹‰ç¦æ­¢*/
1262   1          GP34 = 1;            /*linèŠ¯ç‰‡å”¤é†’ç®¡æ•™*/
1263   1        //  ä¸åŒæ¿å­å”¤é†’ç®¡è„šå¯èƒ½ä¸åŒ  
1264   1        SetBit(P1_OE, PIN0); /*è¾“å…¥æ¨¡å¼*/
1265   1        ClrBit(P1_PU, PIN0); /*ä¸Šæ‹‰ç¦æ­¢*/
1266   1          GP10 = 1;            /*linèŠ¯ç‰‡å”¤é†’ç®¡æ•™*/
1267   1        
1268   1        
1269   1          while (1)
1270   1          {
1271   2              SetBit(WDT_CR, WDTRF);     /* å–‚ç‹— */
1272   2              LIN_detect();
1273   2              LIN_Resp(); /* æ•°æ®å‘é€ */
1274   2          }
1275   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   3296    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =    129    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      5      47
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
